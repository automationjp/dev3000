#!/bin/sh
set -e

# Lint (auto-fix)
pnpm run lint:fix

echo "ðŸ”§ Running typecheck..."
pnpm run typecheck

echo "ðŸ§ª Running Node tests..."
pnpm run test

# Detect staged changes
CHANGED="$(git diff --cached --name-only --diff-filter=ACM)"

# Run ShellSpec only if Makefile or scripts/ changed
if printf "%s" "$CHANGED" | grep -Eq '^(Makefile|scripts/)'; then
  echo "ðŸ§ª Running ShellSpec (Makefile/scripts changed)"
  NON_INTERACTIVE=1 pnpm run shellspec -- --format progress --jobs 2
fi

# Run frontend tests only if frontend/ changed
if printf "%s" "$CHANGED" | grep -Eq '^frontend/'; then
  if [ -f frontend/package.json ]; then
    echo "ðŸ§ª Running frontend tests..."
    (
      cd frontend
      pnpm install --frozen-lockfile || pnpm install
      if node -e 'const pkg=require("./package.json"); process.exit(pkg.scripts && pkg.scripts.test ? 0 : 1)' ; then
        pnpm test
      else
        echo "No frontend tests defined; skipping"
      fi
    )
  fi
fi
fi
